{% extends "base.html" %}
{% block title %}{{ STORES.get(store_id, store_id) }} - {{ year }}年{{ month }}月 シフト編集{% endblock %}

{% block content %}
<h1>{{ STORES.get(store_id, store_id) }} - {{ year }}年{{ month }}月 シフト編集</h1>

<div class="navline">
  <a class="btn" href="{{ url_for('schedule', store_id=store_id, year=prev_y, month=prev_m) }}">« 前月</a>
  <a class="btn" href="{{ url_for('schedule', store_id=store_id, year=next_y, month=next_m) }}">次月 »</a>
  <div class="spacer"></div>
  <a class="btn" href="{{ url_for('settings', store_id=store_id) }}">スタッフ名の設定</a>
  <a class="btn" href="{{ url_for('view', store_id=store_id, year=year, month=month) }}">閲覧</a>
  <a class="btn" href="{{ url_for('logout', store_id=store_id) }}">ログアウト</a>
</div>

<form method="post">
  {% set first_wday = calendar.weekday(year, month, 1) %}
  {% set nd = ndays %}

  <div class="only-desktop cal">
    <div class="cal-header">
      <div class="col week">週</div>
      {% for wd in range(7) %}
        <div class="col">{{ ["日","月","火","水","木","金","土"][wd] }}</div>
      {% endfor %}
    </div>

    {% for w in range(6) %}
      <div class="cal-row">
        <div class="col week">第{{ w+1 }}週</div>
        {% for wd in range(7) %}
          {% set d = (w*7 + wd - first_wday + 1) %}
          {% if 1 <= d <= nd %}
            {% set cls = "day" %}
            {% if wd == 0 %}{% set cls = cls + " sun" %}{% elif wd == 6 %}{% set cls = cls + " sat" %}{% endif %}
            <div class="cell {{ cls }}">
              <div class="daynum">{{ d }}日</div>
              <div class="shifts">
                {% for key, label, cap in [("am0","早朝",1),("am","午前",2),("pm","午後",2),("eve","夕方",2),("night","深夜",1)] %}
                  <div class="shift-line">
                    <div class="shift-label">{{ label }}</div>
                    <div class="shift-names">
                      {% for i in range(cap) %}
                        {% set current = (data.get(d|string, {}).get(key, [])|default([])) %}
                        {% set val = current[i] if i < len(current) else "" %}
                        <select name="e_{{ '%02d' % d }}_{{ key }}_{{ i+1 }}" class="pill">
                          <option value="">（未選択）</option>
                          {% for n in names %}
                            <option value="{{ n }}" {% if n==val %}selected{% endif %}>{{ n }}</option>
                          {% endfor %}
                        </select>
                      {% endfor %}
                    </div>
                  </div>
                {% endfor %}
              </div>
            </div>
          {% else %}
            <div class="cell"></div>
          {% endif %}
        {% endfor %}
      </div>
    {% endfor %}
  </div>

  <div class="only-mobile">
    {% for d in range(1, nd+1) %}
      <div class="card">
        <div class="daynum">{{ d }}日</div>
        {% for key, label, cap in [("am0","早朝",1),("am","午前",2),("pm","午後",2),("eve","夕方",2),("night","深夜",1)] %}
          <div class="shift-line">
            <div class="shift-label">{{ label }}</div>
            <div class="shift-names">
              {% set current = (data.get(d|string, {}).get(key, [])|default([])) %}
              {% for i in range(cap) %}
                {% set val = current[i] if i < len(current) else "" %}
                <select name="e_{{ '%02d' % d }}_{{ key }}_{{ i+1 }}" class="pill">
                  <option value="">（未選択）</option>
                  {% for n in names %}
                    <option value="{{ n }}" {% if n==val %}selected{% endif %}>{{ n }}</option>
                  {% endfor %}
                </select>
              {% endfor %}
            </div>
          </div>
        {% endfor %}
      </div>
    {% endfor %}
  </div>

  <div style="margin-top:16px">
    <button class="btn btn-primary" type="submit">保存する</button>
  </div>
</form>
{% endblock %}
