<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>シフト編集 | {{ store_name }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <style>
    .container{max-width:1100px;margin:0 auto;padding:0 12px;}
    .toolbar{display:flex;gap:8px;align-items:center;justify-content:space-between;margin:14px 0;flex-wrap:wrap}
    .toolbar .right{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .btn{display:inline-block;padding:10px 14px;border-radius:8px;border:1px solid #d1d5db;background:#fff;cursor:pointer;font:inherit}
    .btn-primary{border-color:#2563eb;background:#3b82f6;color:#fff;font-weight:600}
    .btn-link{border-color:#e5e7eb;background:#f9fafb}
    .flash{margin:12px 0;padding:10px 12px;border-radius:8px}
    .flash.success{background:#e6ffed;border:1px solid #b7ebc6}
    .flash.error{background:#ffecec;border:1px solid #ffb5b5}
    .save-bar{position:sticky;bottom:0;z-index:20;background:rgba(255,255,255,.96);border-top:1px solid #e5e7eb;padding:10px 12px;backdrop-filter:saturate(180%) blur(4px)}
    .save-bar .container{display:flex;justify-content:flex-end}

    /* ===== PC：週ごとの表 ===== */
    .desktop-table{display:block}
    .mobile-cards{display:none}
    .table-wrap{overflow-x:auto}
    table{border-collapse:collapse;width:100%;min-width:980px}
    th,td{border:1px solid #e5e7eb;padding:8px;vertical-align:top}
    th{background:#f7fafc;text-align:center}
    .day-cell{min-width:180px}
    .day-title{font-weight:700;margin-bottom:6px}
    .shift-block{display:grid;grid-template-columns:1fr 1fr;gap:6px;margin:6px 0}

    /* ===== スマホ：1日ごとのカード ===== */
    @media (max-width: 768px){
      .desktop-table{display:none}
      .mobile-cards{display:block}
      .card{border:1px solid #e5e7eb;border-radius:12px;padding:12px;margin:10px 0;background:#fff}
      .card h3{margin:0 0 8px}
      .shift-block{grid-template-columns:1fr}
      input,select,button{width:100%;box-sizing:border-box;padding:12px 14px;font-size:16px}
      table{min-width:720px}
    }
  </style>
</head>
<body>
<div class="container">
  <h1>シフト編集（{{ year }}年{{ month }}月）</h1>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="flash {{ category }}">{{ message }}</div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <form method="post" action="{{ url_for('schedule', store_id=store_id) }}">
    <input type="hidden" name="year"  value="{{ year }}">
    <input type="hidden" name="month" value="{{ month }}">

    <div class="toolbar">
      <div class="left"><strong>{{ store_name }}</strong></div>
      <div class="right">
        <a class="btn btn-link" href="{{ url_for('settings', store_id=store_id) }}">スタッフ名の設定</a>
        <a class="btn" href="{{ url_for('schedule', store_id=store_id, year=prev_year, month=prev_month) }}">← 前月</a>
        <select onchange="location.href=this.value">
          {% for y in year_options %}
            {% for m in month_options %}
              <option value="{{ url_for('schedule', store_id=store_id, year=y, month=m) }}"
                {% if y==year and m==month %}selected{% endif %}>{{ y }}年 {{ m }}月</option>
            {% endfor %}
          {% endfor %}
        </select>
        <a class="btn" href="{{ url_for('schedule', store_id=store_id, year=next_year, month=next_month) }}">次月 →</a>
        <button type="submit" class="btn btn-primary">保存する</button>
      </div>
    </div>

    <!-- ===== PC：週ごとの表（Sun→Sat） ===== -->
    <div class="desktop-table">
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th style="width:80px">週</th>
              <th>日</th><th>月</th><th>火</th><th>水</th><th>木</th><th>金</th><th>土</th>
            </tr>
          </thead>
          <tbody>
            {% for week in weeks %}
              <tr>
                <th>第{{ loop.index }}週</th>
                {% for day in week %}
                  <td class="day-cell">
                    {% if day == 0 %}
                      <div class="day-title" style="opacity:.5">—</div>
                    {% else %}
                      {% set d = day|string %}
                      <div class="day-title">{{ day }}日</div>
                      {% for s in shifts %}
                        {% set cur = prefill.get(d, {}).get(s, ["",""]) %}
                        <div class="shift-block">
                          <label>
                            {{ shifts_labels[s] }}（1）
                            <select name="day_{{ day }}_{{ s }}_1">
                              <option value=""></option>
                              {% for emp in employees %}
                                <option value="{{ emp }}" {% if cur[0]==emp %}selected{% endif %}>{{ emp }}</option>
                              {% endfor %}
                            </select>
                          </label>
                          <label>
                            {{ shifts_labels[s] }}（2）
                            <select name="day_{{ day }}_{{ s }}_2">
                              <option value=""></option>
                              {% for emp in employees %}
                                <option value="{{ emp }}" {% if cur[1]==emp %}selected{% endif %}>{{ emp }}</option>
                              {% endfor %}
                            </select>
                          </label>
                        </div>
                      {% endfor %}
                    {% endif %}
                  </td>
                {% endfor %}
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- ===== スマホ：1日ごとのカード ===== -->
    <div class="mobile-cards">
      {% for week in weeks %}
        {% for day in week %}
          {% if day != 0 %}
            {% set d = day|string %}
            <div class="card">
              <h3>{{ day }}日</h3>
              {% for s in shifts %}
                {% set cur = prefill.get(d, {}).get(s, ["",""]) %}
                <div class="shift-block">
                  <label>
                    {{ shifts_labels[s] }}（1）
                    <select name="day_{{ day }}_{{ s }}_1">
                      <option value=""></option>
                      {% for emp in employees %}
                        <option value="{{ emp }}" {% if cur[0]==emp %}selected{% endif %}>{{ emp }}</option>
                      {% endfor %}
                    </select>
                  </label>
                  <label>
                    {{ shifts_labels[s] }}（2）
                    <select name="day_{{ day }}_{{ s }}_2">
                      <option value=""></option>
                      {% for emp in employees %}
                        <option value="{{ emp }}" {% if cur[1]==emp %}selected{% endif %}>{{ emp }}</option>
                      {% endfor %}
                    </select>
                  </label>
                </div>
              {% endfor %}
            </div>
          {% endif %}
        {% endfor %}
      {% endfor %}
    </div>

    <div class="save-bar">
      <div class="container">
        <button type="submit" class="btn btn-primary">保存する</button>
      </div>
    </div>
  </form>
</div>
</body>
</html>
