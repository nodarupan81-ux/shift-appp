<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>シフト編集 | {{ store_name }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <style>
    /* 最低限の保険（既存CSSの上書きが必要なとき用） */
    .container{max-width:960px;margin:0 auto;padding:0 12px;}
    .toolbar{display:flex;gap:8px;align-items:center;justify-content:space-between;margin:12px 0;flex-wrap:wrap;}
    .toolbar .right{display:flex;gap:8px;align-items:center;}
    .table-wrap{overflow-x:auto;-webkit-overflow-scrolling:touch;}
    table{border-collapse:collapse;width:100%;min-width:960px;}
    th,td{border:1px solid #e5e7eb;padding:6px 8px;vertical-align:top;}
    th{background:#f7fafc;text-align:center;}
    .day-cell{min-width:160px}
    .shift-block{margin:4px 0;display:grid;grid-template-columns:1fr 1fr;gap:6px;}
    .day-header{font-weight:700;margin-bottom:4px;}
    .saved{color:#16a34a;font-weight:600;font-size:12px;margin-left:6px;}
    .flash{margin:12px 0;padding:10px 12px;border-radius:8px;}
    .flash.success{background:#e6ffed;border:1px solid #b7ebc6;}
    .flash.error{background:#ffecec;border:1px solid #ffb5b5;}
    .save-bar{
      position:sticky;bottom:0;z-index:50;background:rgba(255,255,255,0.96);
      border-top:1px solid #e5e7eb;padding:10px 12px;backdrop-filter:saturate(180%) blur(4px);
    }
    .save-bar .container{display:flex;justify-content:flex-end;}
    .btn{display:inline-block;padding:10px 14px;border-radius:8px;border:1px solid #d1d5db;background:#fff;cursor:pointer;font:inherit;}
    .btn-primary{border-color:#2563eb;background:#3b82f6;color:#fff;font-weight:600;}
    .btn-primary:hover{filter:brightness(.97);}
    @media (max-width:640px){
      .save-bar{position:fixed;left:0;right:0}
      input[type="text"],input[type="password"],select,button,.btn{width:100%;box-sizing:border-box;padding:12px 14px;font-size:16px;}
      .shift-block{grid-template-columns:1fr}
      table{min-width:720px;}
    }
  </style>
</head>
<body>

<div class="container">
  <h1>シフト編集（{{ year }}年{{ month }}月）</h1>

  {# フラッシュメッセージ表示 #}
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="flash {{ category }}">{{ message }}</div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <form method="post" action="{{ url_for('schedule', store_id=store_id) }}">
    <input type="hidden" name="year"  value="{{ year }}">
    <input type="hidden" name="month" value="{{ month }}">

    <div class="toolbar">
      <div class="left">
        <strong>{{ store_name }}</strong>
      </div>
      <div class="right">
        <div>
          <a class="btn" href="{{ url_for('schedule', store_id=store_id, year=prev_year, month=prev_month) }}">← 前月</a>
        </div>
        <div>
          <select onchange="location.href=this.value">
            {% for y in year_options %}
              {% for m in month_options %}
                <option value="{{ url_for('schedule', store_id=store_id, year=y, month=m) }}"
                  {% if y==year and m==month %}selected{% endif %}>
                  {{ y }}年 {{ m }}月
                </option>
              {% endfor %}
            {% endfor %}
          </select>
        </div>
        <div>
          <a class="btn" href="{{ url_for('schedule', store_id=store_id, year=next_year, month=next_month) }}">次月 →</a>
        </div>
        <div>
          <button type="submit" class="btn btn-primary">保存する</button>
        </div>
      </div>
    </div>

    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th style="width:80px">週</th>
            {% for d in range(1,8) %}
              <th>日付 / シフト</th>
            {% endfor %}
          </tr>
        </thead>
        <tbody>
          {# weeks は calendar.Calendar(...).monthdayscalendar の返り値（各週=7要素, 月外は0） #}
          {% for w_idx, week in enumerate(weeks, start=1) %}
            <tr>
              <th>第{{ w_idx }}週</th>
              {% for day in week %}
                <td class="day-cell">
                  {% if day == 0 %}
                    <!-- 月外 -->
                    <div class="day-header" style="opacity:.5">—</div>
                  {% else %}
                    {% set day_key = day|string %}
                    <div class="day-header">
                      {{ day }}日
                      {% if prefill.get(day_key) %}
                        <span class="saved">保存済</span>
                      {% endif %}
                    </div>

                    {% for s in shifts %}
                      {% set current = prefill.get(day_key, {}).get(s, ["",""]) %}
                      <div class="shift-block">
                        <label>
                          {{ shifts_labels[s] }}（1）
                          <select name="day_{{ day }}_{{ s }}_1">
                            <option value=""></option>
                            {% for emp in employees %}
                              <option value="{{ emp }}" {% if current[0]==emp %}selected{% endif %}>{{ emp }}</option>
                            {% endfor %}
                          </select>
                        </label>
                        <label>
                          {{ shifts_labels[s] }}（2）
                          <select name="day_{{ day }}_{{ s }}_2">
                            <option value=""></option>
                            {% for emp in employees %}
                              <option value="{{ emp }}" {% if current[1]==emp %}selected{% endif %}>{{ emp }}</option>
                            {% endfor %}
                          </select>
                        </label>
                      </div>
                    {% endfor %}
                  {% endif %}
                </td>
              {% endfor %}
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- 下部固定の保存バー -->
    <div class="save-bar">
      <div class="container">
        <button type="submit" class="btn btn-primary">保存する</button>
      </div>
    </div>
  </form>
</div>

</body>
</html>
