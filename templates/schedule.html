<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{{ store_name }} - {{ year }}年{{ month }}月 シフト表</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <style>
    /* ここはテンプレート専用の最小追加。既存 style.css と衝突しません */
    .calendar { width:100%; border-collapse: collapse; table-layout: fixed; }
    .calendar th, .calendar td { border:1px solid rgba(0,0,0,.18); vertical-align: top; background: rgba(255,255,255,.75); }
    .calendar th { text-align:center; padding:.5rem .25rem; background: rgba(255,255,255,.9); }
    .calendar .daybox { padding:.35rem; min-height: 9.5rem; display:flex; flex-direction:column; gap:.25rem; }
    .daybox .dhead { display:flex; justify-content:space-between; align-items:center; font-weight:700; }
    .shift-row { display:grid; grid-template-columns: 2.8rem 1fr 1fr; gap:.25rem; align-items:center; padding:.15rem 0; border-top:1px solid rgba(0,0,0,.12); }
    .shift-row:first-of-type { border-top:none; }
    .shift-label { font-size:.85rem; text-align:center; border-right:1px solid rgba(0,0,0,.12); }
    .name-pill { display:inline-block; background:#f7f7f7; border:1px solid rgba(0,0,0,.15); border-radius:8px; padding:.15rem .35rem; font-size:.9rem; }
    .sel { width:100%; padding:.25rem .35rem; }
    .toolbar { display:flex; gap:.5rem; flex-wrap:wrap; align-items:center; margin: .5rem 0 1rem; }
    .toolbar a, .toolbar button { white-space:nowrap; }
    .weeks-col { width:3rem; font-weight:700; text-align:center; background: rgba(255,255,255,.9); }
    @media (max-width: 768px) {
      .daybox { min-height: 8.5rem; }
      .shift-row { grid-template-columns: 2.6rem 1fr 1fr; }
    }
  </style>
</head>
<body>

  <div class="container">
    <h2 style="margin-top:1rem;">
      {{ store_name }} - {{ year }}年{{ month }}月 シフト表
    </h2>

    <div class="toolbar">
      <a href="{{ url_for('schedule' if is_admin else 'view', store_id=store_id, year=prev_year, month=prev_month) }}">« 前の月</a>
      <a href="{{ url_for('schedule' if is_admin else 'view', store_id=store_id) }}">今月へ</a>
      <a href="{{ url_for('schedule' if is_admin else 'view', store_id=store_id, year=next_year, month=next_month) }}">次の月 »</a>

      <form method="get" action="{{ url_for('schedule' if is_admin else 'view', store_id=store_id) }}" style="display:inline-flex; gap:.25rem; align-items:center;">
        <select name="year" class="sel">
          {% for y in year_options %}
            <option value="{{ y }}" {% if y == year %}selected{% endif %}>{{ y }}</option>
          {% endfor %}
        </select>
        <span>年</span>
        <select name="month" class="sel">
          {% for m in month_options %}
            <option value="{{ m }}" {% if m == month %}selected{% endif %}>{{ m }}</option>
          {% endfor %}
        </select>
        <span>月</span>
        <button type="submit">移動</button>
      </form>

      <div style="margin-left:auto;"></div>
      {% if is_admin %}
        <a href="{{ url_for('settings', store_id=store_id) }}">名簿・定員</a>
        <a href="{{ url_for('logout') }}">ログアウト</a>
      {% else %}
        <a href="{{ url_for('login_admin', store_id=store_id, next=request.full_path) }}">管理者ログイン</a>
        <a href="{{ url_for('staff_logout', store_id=store_id) }}">スタッフログアウト</a>
      {% endif %}
    </div>

    <form method="post" action="{{ url_for('schedule', store_id=store_id) if is_admin else '#' }}">
      {% if is_admin %}
        <input type="hidden" name="year" value="{{ year }}">
        <input type="hidden" name="month" value="{{ month }}">
      {% endif %}

      <table class="calendar">
        <thead>
          <tr>
            <th class="weeks-col">週</th>
            {% for wd in weekdays %}
              <th>{{ wd }}</th>
            {% endfor %}
          </tr>
        </thead>
        <tbody>

          {# === 週ループ（enumerate禁止→loop.index使用） === #}
          {% for week in weeks %}
          <tr>
            <td class="weeks-col">第{{ loop.index }}週</td>

            {# === 曜日ループ（week は 0 or 日にちの整数） === #}
            {% for day in week %}
            <td>
              {% if day == 0 %}
                <div class="daybox" aria-hidden="true"></div>
              {% else %}
                {% set day_key = day|string %}
                <div class="daybox">
                  <div class="dhead">
                    <div>{{ day }}日</div>
                    {% if prefill.get(day_key) %}
                      <div style="font-size:.8rem; opacity:.7;">保存済</div>
                    {% endif %}
                  </div>

                  {# === シフト行 === #}
                  {% for s in shifts %}
                    {% set label = shifts_labels.get(s, s) %}
                    {% set current = prefill.get(day_key, {}).get(s, ["",""]) %}
                    <div class="shift-row">
                      <div class="shift-label">{{ label }}</div>

                      {% if is_admin %}
                        <div>
                          <select class="sel" name="day_{{ day }}_{{ s }}_1">
                            <option value="">－</option>
                            {% for emp in employees %}
                              <option value="{{ emp }}" {% if current and current[0]==emp %}selected{% endif %}>{{ emp }}</option>
                            {% endfor %}
                          </select>
                        </div>
                        <div>
                          <select class="sel" name="day_{{ day }}_{{ s }}_2">
                            <option value="">－</option>
                            {% for emp in employees %}
                              <option value="{{ emp }}" {% if current and current[1]==emp %}selected{% endif %}>{{ emp }}</option>
                            {% endfor %}
                          </select>
                        </div>
                      {% else %}
                        <div>
                          {% if current and current[0] %}
                            <span class="name-pill">{{ current[0] }}</span>
                          {% else %}
                            <span style="opacity:.5;">－</span>
                          {% endif %}
                        </div>
                        <div>
                          {% if current and current[1] %}
                            <span class="name-pill">{{ current[1] }}</span>
                          {% else %}
                            <span style="opacity:.5;">－</span>
                          {% endif %}
                        </div>
                      {% endif %}
                    </div>
                  {% endfor %}
                </div>
              {% endif %}
            </td>
            {% endfor %}
          </tr>
          {% endfor %}

        </tbody>
      </table>

      {% if is_admin %}
        <div style="margin:1rem 0; display:flex; gap:.5rem;">
          <button type="submit">保存する</button>
          <a href="{{ url_for('view', store_id=store_id, year=year, month=month) }}">閲覧モードで確認</a>
        </div>
      {% endif %}
    </form>

    <div style="margin-top:1rem; font-size:.85rem; opacity:.7;">
      最終表示: {{ now.strftime('%Y-%m-%d') }}
    </div>
  </div>

</body>
</html>
